<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eric's Station V5.3</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { 
            --primary: #5a4fcf; --bg: #f0f2f5; --white: #ffffff; --text: #2d3436;
            --sidebar-width: 220px; --success: #00b894; --warn: #fdcb6e; --danger: #ff7675;
        }
        body { font-family: "Segoe UI", system-ui, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; color: var(--text); }
        
        /* === Sidebar & Nav === */
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary), #8e7bf0); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 4px 0 15px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        .app-logo { font-size: 22px; font-weight: 800; margin-bottom: 30px; display: flex; align-items: center; gap: 10px; letter-spacing: 1px; }
        .avatar { width: 32px; height: 32px; background: white; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 14px; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.95); padding: 12px 15px; margin-bottom: 10px; border-radius: 10px; text-align: left; cursor: pointer; font-weight: 600; font-size: 14px; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .day-picker select { width: 100%; padding: 8px; border-radius: 8px; border: none; font-weight: bold; margin-bottom: 20px; cursor: pointer; color: var(--primary); outline: none; }

        /* === Main Content === */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; }
        .section { display: none; animation: fadeIn 0.4s ease-out; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === Dashboard === */
        .dash-header-card { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; border-radius: 16px; padding: 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 8px 20px rgba(108, 92, 231, 0.3); margin-bottom: 20px; }
        .stats-box { display: flex; gap: 40px; text-align: center; }
        .stat-item { cursor: pointer; position: relative; }
        .stat-item:hover .num { text-shadow: 0 0 10px rgba(255,255,255,0.8); }
        .stat-item::after { content: 'âš™ï¸'; position: absolute; top: -5px; right: -15px; font-size: 12px; opacity: 0; transition: 0.2s; }
        .stat-item:hover::after { opacity: 1; }
        .stat-item .num { font-size: 36px; font-weight: 800; line-height: 1; margin-bottom: 5px; }
        
        .control-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-track { width: 100%; height: 10px; background: #dfe6e9; border-radius: 5px; overflow: hidden; margin-top:10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00b894, #55efc4); width: 0%; transition: width 0.6s cubic-bezier(0.22, 1, 0.36, 1); }

        .table-container { background: white; border-radius: 16px; padding: 5px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f1f2f6; color: #636e72; padding: 15px 10px; font-size: 13px; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 2px solid #e1e1e1; text-align: center; }
        td { padding: 12px 10px; border-bottom: 1px solid #f1f1f1; text-align: center; vertical-align: middle; font-size: 14px; }
        
        .tag { display: inline-block; font-size: 10px; padding: 3px 8px; border-radius: 10px; color: white; margin-bottom: 4px; font-weight: bold; }
        .tag.pink { background: #e84393; } .tag.blue { background: #0984e3; } .tag.green { background: #00b894; } .tag.orange { background: #e17055; }
        .check-btn { width: 18px; height: 18px; cursor: pointer; accent-color: var(--primary); }
        .score-input { width: 40px; padding: 5px; text-align: center; border: 1px solid #dfe6e9; border-radius: 6px; font-weight: bold; color: var(--primary); }
        .sign-box { border-bottom: 1px solid #ddd; height: 30px; }

        .rules-card { margin-top: 20px; background: linear-gradient(135deg, #5a4fcf, #6c5ce7); border-radius: 12px; padding: 20px; color: white; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .rules-card h3 { margin-top: 0; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; display: flex; align-items: center; gap: 10px; font-size: 16px; }
        .rules-list { list-style: none; padding: 0; margin: 0; font-size: 13px; line-height: 1.8; }

        /* === Study Room (Reading Layout) === */
        .study-container { background: white; border-radius: 20px; padding: 30px; min-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 5px 25px rgba(0,0,0,0.05); }
        .passage-text { font-size: 18px; line-height: 1.8; color: #2d3436; text-align: justify; margin-bottom: 20px; }
        .vocab-hl { color: #d35400; font-weight: bold; background: #fff5e6; padding: 0 4px; border-radius: 4px; border-bottom: 2px solid #ddd; }
        .quiz-section { margin-top: 20px; padding-top: 20px; border-top: 2px dashed #ddd; }
        .quiz-item { margin-bottom: 15px; }
        .quiz-q { font-weight: bold; font-size: 16px; color: #2c3e50; margin-bottom: 8px; }
        .quiz-opts-row { display: flex; flex-wrap: wrap; gap: 20px; }
        .quiz-opt { cursor: pointer; font-size: 15px; color: #555; display: flex; align-items: center; }
        .quiz-opt input { margin-right: 6px; transform: scale(1.2); }
        .quiz-res { font-weight: bold; margin-left: 10px; display: none; }
        .quiz-res.correct { color: var(--success); } .quiz-res.wrong { color: var(--danger); }
        .listen-item { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 15px; }

        /* === Games === */
        .game-area { background: white; border-radius: 20px; padding: 30px; min-height: 500px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .game-nav { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; }
        .game-btn { background: white; border: 1px solid #eee; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .game-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .flashcard-scene { width: 320px; height: 220px; perspective: 1000px; cursor: pointer; margin: 0 auto 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; background: white; border: 1px solid #eee; }
        .fc-front { color: var(--primary); font-size: 32px; font-weight: 800; } 
        .fc-back { background: var(--primary); color: white; transform: rotateY(180deg); font-size: 26px; font-weight: 600; }
        .pron { font-size: 16px; color: #888; margin-top: 5px; font-weight: normal; font-family: "Arial", sans-serif; }
        .match-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .match-card { background: #f8f9fa; height: 70px; display: flex; align-items: center; justify-content: center; border-radius: 12px; cursor: pointer; font-weight: bold; border: 2px solid transparent; font-size: 14px; user-select: none; box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: 0.1s; }
        .match-card:active { transform: scale(0.95); }
        .match-card.selected { border-color: var(--primary); background: #eeeaf9; color: var(--primary); transform: scale(1.05); }
        .match-card.matched { opacity: 0; pointer-events: none; transition: 0.3s; }
        .sent-box { background: #f8f9fa; padding: 15px; border-radius: 12px; min-height: 60px; display: flex; flex-wrap: wrap; flex-direction: row; gap: 10px; border: 2px dashed #b2bec3; width: 100%; justify-content: flex-start; margin-bottom: 20px; align-items: center; }
        .word-bank { display: flex; flex-wrap: wrap; flex-direction: row; gap: 10px; justify-content: center; margin-top: 20px; width: 100%; }
        .word-chip { background: white; border: 1px solid #dcdde1; padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 600; box-shadow: 0 3px 0 #dcdde1; transition: 0.1s; white-space: nowrap; display: inline-block; }
        .word-chip:active { transform: translateY(3px); box-shadow: none; }
        .regret-btn { background: #ff7675; color: white; border: none; padding: 5px 15px; border-radius: 8px; margin-left: 10px; cursor: pointer; }
        .spell-input { font-size: 24px; padding: 10px; text-align: center; border: 2px solid #ddd; border-radius: 10px; width: 60%; font-family: monospace; }
        .game-stats { display: flex; gap: 20px; margin-bottom: 15px; justify-content: center; background: #f8f9fa; padding: 8px; border-radius: 10px; }
        .stat-pill { font-size: 14px; font-weight: bold; padding: 5px 12px; border-radius: 12px; }
        .stat-pill.ok { background: #dff9fb; color: #00b894; } .stat-pill.err { background: #ffeaa7; color: #d63031; }

        /* Lock Styles */
        .btn-lock { background: #00b894; color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: bold; }
        .btn-lock.unlocked { background: #e74c3c; }
        input:disabled { background: #f5f5f5; opacity: 0.6; }

        /* === æ‰“å°æ ·å¼ === */
        @media print {
            @page { size: A4 landscape; margin: 10mm; }
            body { background: white; -webkit-print-color-adjust: exact; }
            .sidebar, .nav-btn, .day-picker, .stats-box, .progress-section, .control-bar, .game-nav, .study-header button, #studyPagination, .audio-controls, .regret-btn { display: none !important; }
            .main-content { padding: 0; overflow: visible; }
            .dash-header-card { background: none; color: #333; box-shadow: none; padding: 0; margin-bottom: 10px; border-bottom: 2px solid #5a4fcf; }
            .dash-header-card h2 { color: #5a4fcf; }
            #dashboard.active .table-container { box-shadow: none; padding: 0; }
            table { width: 100%; border: 2px solid #333; font-size: 10pt; }
            th { background: #eee !important; color: #000; border: 1px solid #333; padding: 5px; }
            td { border: 1px solid #333; padding: 5px; height: 40px; }
            input[type="checkbox"] { appearance: none; width: 15px; height: 15px; border: 1px solid #333; border-radius: 3px; }
            .score-input, .sign-box { border: none; border-bottom: 1px solid #999; width: 100%; text-align: center; }
            tr:nth-child(7) { page-break-after: always; }
            .rules-card { display: block !important; margin-top: 20px; page-break-inside: avoid; background: none; color: #333; border: 1px solid #333; padding: 10px; box-shadow: none; }
            .rules-list { font-size: 9pt; color: #333; columns: 2; }
            #study.active .study-container { border: none; padding: 0; }
            #study.active .passage-text { text-align: justify; font-size: 12pt; line-height: 1.5; }
            #study.active .quiz-section { border-top: 1px solid #333; }
            #study.active .quiz-opts-row { gap: 30px; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="app-logo"><div class="avatar">EC</div> Eric's Station</div>
    <div class="day-picker"><select id="globalDaySelect" onchange="changeGlobalDay()"></select></div>
    <button class="nav-btn active" onclick="showSection('dashboard', this)">ğŸ›¡ï¸ å¤‡è€ƒæŒ‡æŒ¥å®˜</button>
    <button class="nav-btn" onclick="showSection('game', this)">ğŸ® ç«æŠ€åœº</button>
    <button class="nav-btn" onclick="showSection('study', this)">ğŸ“– æ ¸å¿ƒè®­ç»ƒ</button>
</div>

<div class="main-content">

    <div id="dashboard" class="section active">
        <div class="dash-header-card">
            <div class="header-title"><h2>ğŸ›¡ï¸ KET å¤‡è€ƒæŒ‡æŒ¥å®˜ V5.3</h2><p>æˆ‘åªç®¡åŠªåŠ›--è¾°è¯º | Target: Grade A</p></div>
            <div class="stats-box" onclick="adminScore()" title="ç‚¹å‡»ç®¡ç†ç§¯åˆ†">
                <div class="stat-item"><div class="num" id="displayTotalScore">0</div><div class="label">æ€»ç§¯åˆ† âš™ï¸</div></div>
            </div>
        </div>
        
        <div class="control-bar">
            <div>ğŸ“… å¼€å§‹: <input type="date" id="startDateInput" onchange="updateStartDate()" disabled></div>
            <div style="display:flex; gap:10px;">
                <button onclick="window.print()" style="background:#2d3436; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">ğŸ–¨ï¸ æ‰“å°æ‰“å¡è¡¨</button>
                <button id="lockBtn" class="btn-lock" onclick="toggleLock()">ğŸ”“ è§£é”ç¼–è¾‘</button>
            </div>
        </div>
        
        <div class="progress-section">
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:bold; color:#555;">
                <span>ğŸ å¥–åŠ±è¿›åº¦</span><span id="nextTargetText">ç›®æ ‡: 300åˆ†</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div>
        </div>
        
        <div class="table-container">
            <table>
                <thead>
                    <tr><th style="width:50px;">Day</th><th style="width:70px;">ğŸ“… æ—¥æœŸ</th><th>ğŸ“ å•è¯<br>(+10)</th><th>ğŸ§ å¬è¯»<br>(Rate)</th><th>âœï¸ å†™ä½œ<br>(Score)</th><th>ğŸ—£ï¸ å£è¯­<br>(Score)</th><th>ğŸ“± APP<br>(+5)</th><th>ğŸ‘¨â€ğŸ« å¤–æ•™<br>(+10)</th><th>ğŸ”„ å¤ä¹ <br>(+15)</th><th>å¾—åˆ†</th><th>ç­¾å­—</th><th>ç­¾å­—</th></tr>
                </thead>
                <tbody id="dashBody"></tbody>
            </table>
        </div>

        <div class="rules-card">
            <h3>ğŸ† ç§¯åˆ†ä¸å¥–åŠ±å¥‘çº¦ (Rules & Agreement)</h3>
            <ul class="rules-list">
                <li>âœ… <b>åŸºç¡€åˆ† (10åˆ†):</b> å®Œæˆæ¯æ—¥ HTML å•è¯ä¸å¬è¯»æ‰“å¡ã€‚</li>
                <li>ğŸ“ˆ <b>æŠ€èƒ½åˆ† (Max 40åˆ†):</b> å¬è¯»æ­£ç¡®ç‡â‰¥80%å¾—20åˆ† + å†™ä½œ(1-10åˆ†) + å£è¯­(1-10åˆ†)ã€‚</li>
                <li>ğŸš€ <b>æ‹“å±•åˆ† (5-15åˆ†):</b> APPå­¦ä¹ (å¤šé‚»å›½/ç™¾è¯æ–©)+5åˆ†; å¤–æ•™è¯¾/åŸç‰ˆé˜…è¯»+10åˆ†ã€‚</li>
                <li>ğŸ§  <b>å¤ä¹ åˆ† (15åˆ†):</b> å®ŒæˆæŒ‡å®šçš„â€œé—å¿˜æ›²çº¿â€å¤ä¹ ä»»åŠ¡ã€‚</li>
                <li>ğŸ¤ <b>å¥‘çº¦ç²¾ç¥:</b> æ¯æ—¥å­¦ä¹ ç»“æŸåï¼Œå­©å­ä¸å®¶é•¿å¿…é¡»å…±åŒç­¾å­—ç¡®è®¤ï¼Œç§¯åˆ†æ–¹å¯ç”Ÿæ•ˆï¼</li>
            </ul>
        </div>
    </div>

    <div id="study" class="section">
        <div class="study-container">
            <div class="study-header">
                <h2 style="margin:0; color:#5a4fcf;" id="studyTitle">Day X</h2>
                <div style="display:flex; gap:10px;">
                    <button onclick="window.print()" style="background:#2d3436; border:none; padding:5px 15px; border-radius:15px; color:white;">ğŸ–¨ï¸ æ‰“å°æ­¤é¡µ</button>
                    <button onclick="toggleTrans()" style="background:#fdcb6e; border:none; padding:5px 15px; border-radius:15px; color:white;">ğŸ‘ï¸ ç¿»è¯‘</button>
                </div>
            </div>
            <div id="studyContent"></div>
            <div style="margin-top:auto; padding-top:20px; text-align:center;" id="studyPagination"></div>
        </div>
    </div>

    <div id="game" class="section">
        <div class="game-nav">
            <button class="game-btn active" onclick="setGameMode('flashcard', this)">âš¡ é—ªå¡</button>
            <button class="game-btn" onclick="setGameMode('match', this)">ğŸ§© æ¶ˆæ¶ˆä¹</button>
            <button class="game-btn" onclick="setGameMode('spell', this)">âœï¸ æ‹¼å†™</button>
            <button class="game-btn" onclick="setGameMode('sentence', this)">ğŸš¶â€â™‚ï¸ æ’é˜Ÿè¡Œ</button>
        </div>
        <div class="game-area" id="gameBoard" style="align-items:center; justify-content:center;"></div>
    </div>

</div>

<script>
    // ================== DATA ==================
    const KET_DATA = {
        1: {
            theme: "People & Family",
            vocab: [
                {en: "aunt", cn: "é˜¿å§¨", pron: "/É‘Ënt/"}, {en: "cousin", cn: "å ‚å…„", pron: "/ËˆkÊŒzn/"}, 
                {en: "guest", cn: "å®¢äºº", pron: "/É¡est/"}, {en: "husband", cn: "ä¸ˆå¤«", pron: "/ËˆhÊŒz.bÉ™nd/"}, 
                {en: "neighbor", cn: "é‚»å±…", pron: "/ËˆneÉª.bÉ™r/"}, {en: "surname", cn: "å§“æ°", pron: "/ËˆsÉœË.neÉªm/"}, 
                {en: "teenager", cn: "é’å°‘å¹´", pron: "/ËˆtiËnËŒeÉª.dÊ’É™r/"}, {en: "wife", cn: "å¦»å­", pron: "/waÉªf/"}, 
                {en: "colleague", cn: "åŒäº‹", pron: "/ËˆkÉ’l.iËÉ¡/"}, {en: "adult", cn: "æˆå¹´äºº", pron: "/ËˆÃ¦d.ÊŒlt/"}, 
                {en: "member", cn: "æˆå‘˜", pron: "/Ëˆmem.bÉ™r/"}, {en: "grandchild", cn: "å­™å­", pron: "/ËˆgrÃ¦n.tÊƒaÉªld/"}
            ],
            reading: [
                { 
                    title: "Reading 1: The Family Party", 
                    content: `Hello, my name is Sam. Today is Saturday. We have a big party at my house. There are many <span class="vocab-hl">guests</span>. Look at the woman in the red dress. She is my <span class="vocab-hl">aunt</span>, Lisa. She is my dad's sister. The boy next to her is Mike. He is my <span class="vocab-hl">cousin</span>. Mike is 15 years old. He is a <span class="vocab-hl">teenager</span>. He likes basketball.`, 
                    translation: "ä½ å¥½ï¼Œæˆ‘æ˜¯è¨å§†ã€‚ä»Šå¤©æ˜¯å‘¨å…­ï¼Œæˆ‘å®¶æœ‰ä¸ªå¤§æ´¾å¯¹ã€‚æœ‰å¾ˆå¤šå®¢äººã€‚çœ‹é‚£ä¸ªç©¿çº¢è£™çš„å¥³å£«ï¼Œæ˜¯æˆ‘é˜¿å§¨Lisaï¼Œçˆ¸çˆ¸çš„å§å§ã€‚æ—è¾¹æ˜¯Mikeï¼Œæˆ‘å ‚å…„ï¼Œ15å²ï¼Œæ˜¯ä¸ªé’å°‘å¹´ã€‚",
                    questions: [
                        {q: "1. What day is the party?", opts: ["Sunday", "Saturday", "Friday"], ans: 1},
                        {q: "2. Who is Lisa?", opts: ["Sam's mom", "Sam's aunt", "Sam's sister"], ans: 1},
                        {q: "3. How old is Mike?", opts: ["14", "15", "16"], ans: 1},
                        {q: "4. Who is the teenager?", opts: ["Sam", "Lisa", "Mike"], ans: 2},
                        {q: "5. What does Mike like?", opts: ["Football", "Basketball", "Tennis"], ans: 1}
                    ]
                },
                { 
                    title: "Reading 2: My Neighbors", 
                    content: `I live in a nice house. I have a very good <span class="vocab-hl">neighbor</span>. His name is Mr. White. So his <span class="vocab-hl">surname</span> is White. Mr. White lives with Mrs. White. She is his <span class="vocab-hl">wife</span>, and he is her <span class="vocab-hl">husband</span>. They have no children. They are both <span class="vocab-hl">adults</span>. They like gardening.`, 
                    translation: "æˆ‘ä½åœ¨ä¸€ä¸ªæ¼‚äº®çš„æˆ¿å­é‡Œã€‚æˆ‘æœ‰ä¸€ä¸ªå¥½é‚»å±…å«æ€€ç‰¹å…ˆç”Ÿã€‚ä»–å’Œæ€€ç‰¹å¤ªå¤ªä½ä¸€èµ·ï¼Œå¥¹æ˜¯ä»–çš„å¦»å­ã€‚ä»–ä»¬æ²¡æœ‰å­©å­ï¼Œéƒ½æ˜¯æˆå¹´äººï¼Œå–œæ¬¢å›­è‰ºã€‚",
                    questions: [
                        {q: "1. What is the neighbor's surname?", opts: ["Black", "Green", "White"], ans: 2},
                        {q: "2. Who lives with Mr. White?", opts: ["His sister", "His wife", "His mom"], ans: 1},
                        {q: "3. Do they have children?", opts: ["Yes", "No", "Maybe"], ans: 1},
                        {q: "4. What do they like?", opts: ["Gardening", "Cooking", "Reading"], ans: 0},
                        {q: "5. Mr. and Mrs. White are both ___.", opts: ["Teenagers", "Children", "Adults"], ans: 2}
                    ]
                },
                {
                    title: "Reading 3: My Pet Dog (True or False)",
                    content: `I have a pet dog. His name is Max. Max is brown and white. He loves to run in the park. He plays with a red ball. Max sleeps in my room. He is my best friend.`,
                    translation: "æˆ‘æœ‰ä¸€åªå® ç‰©ç‹—å«Maxã€‚ä»–æ˜¯æ£•ç™½ç›¸é—´çš„ã€‚ä»–å–œæ¬¢åœ¨å…¬å›­è·‘ã€‚ä»–ç©çº¢çƒã€‚Maxç¡æˆ‘æˆ¿é—´ã€‚ä»–æ˜¯æˆ‘æœ€å¥½çš„æœ‹å‹ã€‚",
                    questions: [
                        {q: "1. Max is a cat.", opts: ["True", "False"], ans: 1},
                        {q: "2. Max is brown and white.", opts: ["True", "False"], ans: 0},
                        {q: "3. He loves to swim.", opts: ["True", "False"], ans: 1},
                        {q: "4. He plays with a blue ball.", opts: ["True", "False"], ans: 1},
                        {q: "5. Max sleeps in my room.", opts: ["True", "False"], ans: 0}
                    ]
                }
            ],
            listening: [
                { title: "Listening: Family Members", content: [
                    {text: "1. He works with my dad. He is my dad's ___.", audioText: "This is Mr. Li. He works with my dad. He is my dad's colleague.", translation: "è¿™æ˜¯æå…ˆç”Ÿï¼Œçˆ¸çˆ¸çš„åŒäº‹ã€‚"},
                    {text: "2. My name is Tom Brown. My ___ is Brown.", audioText: "My name is Tom Brown. My surname is Brown.", translation: "æˆ‘å«Tom Brownï¼Œå§“Brownã€‚"},
                    {text: "3. My grandma loves me. I am her happy ___.", audioText: "My grandma loves me very much. I am her happy grandchild.", translation: "å¥¶å¥¶å¾ˆçˆ±æˆ‘ï¼Œæˆ‘æ˜¯å¥¹å¿«ä¹çš„å­™å­ã€‚"},
                    {text: "4. This is not a child. This is an ___.", audioText: "Look at this photo. This is not a child. This is an adult.", translation: "çœ‹ç…§ç‰‡ï¼Œè¿™ä¸æ˜¯å­©å­ï¼Œæ˜¯æˆå¹´äººã€‚"},
                    {text: "5. She is my uncle's wife. She is my ___.", audioText: "She is my uncle's wife. She is my aunt.", translation: "å¥¹æ˜¯æˆ‘å”å”çš„å¦»å­ï¼Œå¥¹æ˜¯æˆ‘çš„é˜¿å§¨ã€‚"}
                ]}
            ],
            sentences: [
                {cn: "è¿™æ˜¯æˆ‘çš„é˜¿å§¨ Lisaã€‚", en: "This is my aunt Lisa", words: ["This", "is", "my", "aunt", "Lisa"]},
                {cn: "æ€€ç‰¹å…ˆç”Ÿæ˜¯æˆ‘çš„é‚»å±…ã€‚", en: "Mr White is my neighbor", words: ["Mr", "White", "is", "my", "neighbor"]},
                {cn: "ä»–æ˜¯ä¸€ä¸ªå¿«ä¹çš„é’å°‘å¹´ã€‚", en: "He is a happy teenager", words: ["He", "is", "a", "happy", "teenager"]},
                {cn: "æˆ‘çš„å§“æ°æ˜¯ Brownã€‚", en: "My surname is Brown", words: ["My", "surname", "is", "Brown"]},
                {cn: "å¥¹æ˜¯ä»–çš„å¦»å­ã€‚", en: "She is his wife", words: ["She", "is", "his", "wife"]}
            ]
        },
        2: {
            theme: "School & Education",
            vocab: [
                {en: "subject", cn: "ç§‘ç›®", pron: "/ËˆsÊŒb.dÊ’ekt/"}, {en: "board", cn: "é»‘æ¿", pron: "/bÉ”Ëd/"}, 
                {en: "break", cn: "ä¼‘æ¯/è¯¾é—´", pron: "/breÉªk/"}, {en: "chemistry", cn: "åŒ–å­¦", pron: "/Ëˆkem.Éª.stri/"}, 
                {en: "college", cn: "å­¦é™¢", pron: "/ËˆkÉ’l.ÉªdÊ’/"}, {en: "course", cn: "è¯¾ç¨‹", pron: "/kÉ”Ës/"}, 
                {en: "exam", cn: "è€ƒè¯•", pron: "/ÉªÉ¡ËˆzÃ¦m/"}, {en: "geography", cn: "åœ°ç†", pron: "/dÊ’iËˆÉ’É¡.rÉ™.fi/"}, 
                {en: "history", cn: "å†å²", pron: "/ËˆhÉªs.tÉ™r.i/"}, {en: "project", cn: "é¡¹ç›®", pron: "/ËˆprÉ’dÊ’.ekt/"}, 
                {en: "ruler", cn: "å°ºå­", pron: "/ËˆruË.lÉ™r/"}, {en: "uniform", cn: "æ ¡æœ", pron: "/ËˆjuË.nÉª.fÉ”Ëm/"}
            ],
            reading: [
                { 
                    title: "Reading 1: My School Day", 
                    content: `I love my school. We study many <span class="vocab-hl">subjects</span>. My favorite subject is <span class="vocab-hl">history</span>. I don't like <span class="vocab-hl">chemistry</span> because it is difficult. We wear a blue <span class="vocab-hl">uniform</span> at school. In the classroom, the teacher writes on the <span class="vocab-hl">board</span>. We have a short <span class="vocab-hl">break</span> in the morning.`, 
                    translation: "æˆ‘çˆ±æˆ‘çš„å­¦æ ¡ã€‚æˆ‘ä»¬å­¦å¾ˆå¤šç§‘ç›®ã€‚æˆ‘æœ€çˆ±å†å²ï¼Œä¸å–œæ¬¢åŒ–å­¦å› ä¸ºå¤ªéš¾ã€‚æˆ‘ä»¬ç©¿è“è‰²æ ¡æœã€‚è€å¸ˆåœ¨é»‘æ¿ä¸Šå†™å­—ã€‚æ—©ä¸Šæˆ‘ä»¬æœ‰çŸ­æš‚ä¼‘æ¯ã€‚",
                    questions: [
                        {q: "1. What is Sam's favorite subject?", opts: ["Math", "History", "Chemistry"], ans: 1},
                        {q: "2. Why doesn't he like Chemistry?", opts: ["It's boring", "It's easy", "It's difficult"], ans: 2},
                        {q: "3. What color is the uniform?", opts: ["Red", "Blue", "White"], ans: 1},
                        {q: "4. Where does the teacher write?", opts: ["On the wall", "On the board", "On the floor"], ans: 1},
                        {q: "5. When is the break?", opts: ["In the morning", "At noon", "In the evening"], ans: 0}
                    ]
                },
                { 
                    title: "Reading 2: The Big Exam", 
                    content: `Today we have a big <span class="vocab-hl">exam</span>. I need my pen and <span class="vocab-hl">ruler</span>. We are doing a <span class="vocab-hl">project</span> about world maps in <span class="vocab-hl">geography</span> class. After high school, I want to go to a good <span class="vocab-hl">college</span>.`, 
                    translation: "ä»Šå¤©æœ‰å¤§è€ƒã€‚æˆ‘éœ€è¦ç¬”å’Œå°ºå­ã€‚åœ°ç†è¯¾æˆ‘ä»¬åœ¨åšä¸–ç•Œåœ°å›¾é¡¹ç›®ã€‚é«˜ä¸­åæˆ‘æƒ³å»å¥½å¤§å­¦ã€‚",
                    questions: [
                        {q: "1. What do they have today?", opts: ["A party", "A big exam", "A holiday"], ans: 1},
                        {q: "2. What does he need?", opts: ["Pen and ruler", "Ball and bat", "Phone"], ans: 0},
                        {q: "3. What class is the project for?", opts: ["History", "Math", "Geography"], ans: 2},
                        {q: "4. What is the project about?", opts: ["Animals", "World maps", "Space"], ans: 1},
                        {q: "5. Where does he want to go?", opts: ["Home", "Park", "College"], ans: 2}
                    ]
                },
                {
                    title: "Reading 3: Mr. Black (True or False)",
                    content: `Mr. Black is our new math teacher. He is very tall and thin. He usually wears a white shirt. He is very funny. We all like him. But he gives us a lot of homework every day.`,
                    translation: "å¸ƒè±å…‹å…ˆç”Ÿæ˜¯æˆ‘ä»¬æ–°æ¥çš„æ•°å­¦è€å¸ˆã€‚ä»–åˆé«˜åˆç˜¦ã€‚é€šå¸¸ç©¿ç™½è¡¬è¡«ã€‚ä»–å¾ˆæœ‰è¶£ã€‚æˆ‘ä»¬éƒ½å–œæ¬¢ä»–ã€‚ä½†ä»–æ¯å¤©ç»™æˆ‘ä»¬å¸ƒç½®å¾ˆå¤šä½œä¸šã€‚",
                    questions: [
                        {q: "1. Mr. Black is a science teacher.", opts: ["True", "False"], ans: 1},
                        {q: "2. He is short and fat.", opts: ["True", "False"], ans: 1},
                        {q: "3. He wears a white shirt.", opts: ["True", "False"], ans: 0},
                        {q: "4. The students like him.", opts: ["True", "False"], ans: 0},
                        {q: "5. He gives no homework.", opts: ["True", "False"], ans: 1}
                    ]
                }
            ],
            listening: [
                { title: "Listening: School Life", content: [
                    {text: "1. Don't forget your ___. You need to draw lines.", audioText: "Don't forget your ruler. You need to draw lines in the math exam.", translation: "åˆ«å¿˜äº†å°ºå­ï¼Œä½ éœ€è¦ç”»çº¿ã€‚"},
                    {text: "2. I wear a white shirt. This is my school ___.", audioText: "I wear a white shirt and grey trousers. This is my school uniform.", translation: "æˆ‘ç©¿ç™½è¡¬è¡«ï¼Œè¿™æ˜¯æˆ‘çš„æ ¡æœã€‚"},
                    {text: "3. Look at the teacher. She is writing on the ___.", audioText: "Look at the teacher. She is writing on the board.", translation: "çœ‹è€å¸ˆï¼Œå¥¹æ­£åœ¨é»‘æ¿ä¸Šå†™å­—ã€‚"},
                    {text: "4. We have a big math ___ today.", audioText: "We have a big math exam today.", translation: "æˆ‘ä»¬ä»Šå¤©æœ‰ä¸ªå¤§çš„æ•°å­¦è€ƒè¯•ã€‚"},
                    {text: "5. History is my favorite ___.", audioText: "History is my favorite subject.", translation: "å†å²æ˜¯æˆ‘æœ€çˆ±çš„ç§‘ç›®ã€‚"}
                ]}
            ],
            sentences: [
                {cn: "å†å²æ˜¯æˆ‘æœ€çˆ±çš„ç§‘ç›®ã€‚", en: "History is my favorite subject", words: ["History", "is", "my", "favorite", "subject"]},
                {cn: "å¥¹åœ¨é»‘æ¿ä¸Šå†™å­—ã€‚", en: "She writes on the board", words: ["She", "writes", "on", "the", "board"]},
                {cn: "åˆ«å¿˜äº†ä½ çš„å°ºå­ã€‚", en: "Do not forget your ruler", words: ["Do", "not", "forget", "your", "ruler"]},
                {cn: "æˆ‘ä»¬æœ‰ä¸€ä¸ªçŸ­æš‚çš„ä¼‘æ¯ã€‚", en: "We have a short break", words: ["We", "have", "a", "short", "break"]},
                {cn: "æˆ‘ç©¿ç€æˆ‘çš„æ ¡æœã€‚", en: "I am wearing my uniform", words: ["I", "am", "wearing", "my", "uniform"]}
            ]
        }
    };

    // ================= LOGIC =================
    let currentDay = 1;
    let currentData = KET_DATA[1];
    let isTeacherMode = false;
    let quizState = { answers: {}, submitted: false };
    let gameState = { mode: 'flashcard', idx: 0, match: {deck:[], selected:[], resolved:[], init: false}, spell:{correct:0,wrong:0}, sentence:{idx:0,userWords:[],regretUsed:0,correctCount:0} };

    window.onload = function() {
        let sd = localStorage.getItem('ket_start_date') || new Date().toISOString().split('T')[0];
        document.getElementById('startDateInput').value = sd;
        let sel = document.getElementById('globalDaySelect');
        for(let i=1; i<=14; i++) { let opt=document.createElement('option'); opt.value=i; opt.innerText=`Day ${i}`; sel.appendChild(opt); }
        loadDayData(1);
        renderDashboard();
    };

    function updateStartDate() { localStorage.setItem('ket_start_date', document.getElementById('startDateInput').value); renderDashboard(); }
    function changeGlobalDay() { loadDayData(parseInt(document.getElementById('globalDaySelect').value)); }
    
    function loadDayData(day) {
        currentDay = day;
        currentData = KET_DATA[day] || KET_DATA[1];
        document.getElementById('studyTitle').innerText = `Day ${day}: ${currentData.theme}`;
        quizState = { answers: {}, submitted: false }; // Reset Quiz
        if(document.getElementById('study').classList.contains('active')) renderStudyPage(0);
        if(document.getElementById('game').classList.contains('active')) renderGame();
    }

    function renderDashboard() {
        const tbody = document.getElementById('dashBody'); tbody.innerHTML = '';
        let totalScore = 0;
        const startDate = new Date(localStorage.getItem('ket_start_date') || new Date());
        const disabled = isTeacherMode ? '' : 'disabled';

        for(let i=1; i<=14; i++) {
            let dDate = new Date(startDate); dDate.setDate(startDate.getDate() + (i-1));
            let dateStr = `${(dDate.getMonth()+1)}/${dDate.getDate()}`;
            let data = JSON.parse(localStorage.getItem(`day_${i}_data`) || '{}');
            
            let score = 0;
            if(data.vocab) score+=10; if(data.apps) score+=5; if(data.teacher) score+=10;
            if(data.reviews) Object.values(data.reviews).forEach(v => {if(v) score+=15});
            if(data.deduction) score-=data.deduction; 
            totalScore += score;

            // é—å¿˜æ›²çº¿
            let curveHtml = '';
            [1,2,4,7,15].forEach(gap => {
                if(i > gap) { 
                    let target = i - gap;
                    curveHtml += `<label style="display:block;font-size:10px;"><input type="checkbox" ${data.reviews&&data.reviews[target]?'checked':''} ${disabled} onchange="updRev(${i},${target},this.checked)"> å¤ä¹ D${target}</label>`;
                }
            });

            tbody.innerHTML += `<tr>
                <td style="font-weight:bold; color:var(--primary)">D${i}</td>
                <td style="font-size:12px;">${dateStr}</td>
                <td><input type="checkbox" class="check-btn" ${data.vocab?'checked':''} ${disabled} onchange="updData(${i},'vocab',this.checked)"></td>
                <td><input class="score-input" value="${data.listen||''}" ${disabled} onchange="updData(${i},'listen',this.value)"></td>
                <td><input class="score-input" value="${data.write||''}" ${disabled} onchange="updData(${i},'write',this.value)"></td>
                <td><input class="score-input" value="${data.speak||''}" ${disabled} onchange="updData(${i},'speak',this.value)"></td>
                <td><input type="checkbox" class="check-btn" ${data.apps?'checked':''} ${disabled} onchange="updData(${i},'apps',this.checked)"></td>
                <td><input type="checkbox" class="check-btn" ${data.teacher?'checked':''} ${disabled} onchange="updData(${i},'teacher',this.checked)"></td>
                <td>${curveHtml}</td>
                <td style="font-weight:bold; color:var(--primary)">${score}</td>
                <td><div class="sign-box"></div></td>
                <td><div class="sign-box"></div></td>
            </tr>`;
        }
        
        // Add Admin Bonus
        let extraBonus = parseInt(localStorage.getItem('ket_extra_bonus') || '0');
        totalScore += extraBonus;

        document.getElementById('displayTotalScore').innerText = totalScore;
        let pct = (totalScore % 300) / 300 * 100;
        document.getElementById('progressBar').style.width = `${pct}%`;
        document.getElementById('nextTargetText').innerText = `ç›®æ ‡: ${Math.ceil((totalScore+1)/300)*300}åˆ†`;
    }

    function updData(d,k,v) { let obj = JSON.parse(localStorage.getItem(`day_${d}_data`)||'{}'); obj[k]=v; localStorage.setItem(`day_${d}_data`, JSON.stringify(obj)); renderDashboard(); }
    function updRev(d,t,v) { let obj = JSON.parse(localStorage.getItem(`day_${d}_data`)||'{}'); if(!obj.reviews)obj.reviews={}; obj.reviews[t]=v; localStorage.setItem(`day_${d}_data`, JSON.stringify(obj)); renderDashboard(); }
    function deductScore(p) { let d=JSON.parse(localStorage.getItem(`day_${currentDay}_data`)||'{}'); d.deduction=(d.deduction||0)+p; localStorage.setItem(`day_${currentDay}_data`,JSON.stringify(d)); renderDashboard(); }

    function toggleLock() {
        if(isTeacherMode) {
            isTeacherMode = false; document.getElementById('lockBtn').innerText="ğŸ”“ è§£é”ç¼–è¾‘"; document.getElementById('startDateInput').disabled=true;
        } else {
            if(prompt("å¯†ç :")==="777") { isTeacherMode = true; document.getElementById('lockBtn').innerText="ğŸ”’ é”å®š"; document.getElementById('startDateInput').disabled=false; }
        }
        renderDashboard();
    }

    function adminScore() {
        let pwd = prompt("è¯·è¾“å…¥ç§¯åˆ†ç®¡ç†å‘˜å¯†ç :");
        if (pwd !== "999") { if(pwd) alert("å¯†ç é”™è¯¯"); return; }
        let curr = parseInt(localStorage.getItem('ket_extra_bonus') || '0');
        let val = prompt(`ã€ç§¯åˆ†å¹²é¢„ã€‘\nå½“å‰é¢å¤–å¥–æƒ©åˆ†: ${curr}\n\nè¯·è¾“å…¥å¢åŠ /æ‰£é™¤çš„åˆ†æ•° (å¦‚ +50 æˆ– -20):`, "0");
        if(val && val.trim()!=="") {
            let n = parseInt(val);
            if(!isNaN(n)) { localStorage.setItem('ket_extra_bonus', curr + n); alert("å·²æ›´æ–°!"); renderDashboard(); }
        }
    }

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(e=>e.classList.remove('active')); document.getElementById(id).classList.add('active');
        if(btn) { document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); btn.classList.add('active'); }
        if(id==='study') renderStudyPage(0); if(id==='game') renderGame();
    }

    // === Study Page ===
    function renderStudyPage(idx) {
        const container = document.getElementById('studyContent');
        if(!currentData.reading) { container.innerHTML="æš‚æ— å†…å®¹"; return; }
        let pages = (currentData.reading||[]).concat(currentData.listening||[]);
        if(pages.length===0) return;
        let p = pages[idx];
        
        let contentHtml = '';
        
        if(p.content && Array.isArray(p.content)) { // Listening
             contentHtml = `<h3>${p.title||'Listening'}</h3>` + p.content.map(i => `<div class="listen-item"><span>${i.text}</span><button onclick="speak('${i.audioText}')">ğŸ”Š</button><div class="translation-box" style="display:none;color:#666;margin-top:5px;font-size:13px;">${i.translation}</div></div>`).join('');
        } 
        else { // Reading with Quiz
             contentHtml = `<h3>${p.title||'Reading'}</h3>
                            <div class="passage-text">${p.content}</div>
                            <div class="translation-box" style="display:none;background:#f9f9f9;padding:10px;margin-top:10px;border-left:3px solid var(--warn);">${p.translation}</div>
                            <button onclick="speak(document.querySelector('.passage-text').innerText)" style="margin-top:15px;background:#00b894;color:white;border:none;padding:5px 15px;border-radius:15px;cursor:pointer;">ğŸ”Š æœ—è¯»æ–‡ç« </button>`;
             
             if(p.questions) {
                 let quizHtml = `<div class="quiz-section"><h3>Questions</h3>`;
                 p.questions.forEach((q, i) => {
                     let qKey = `q${idx}_${i}`;
                     let userAns = quizState.answers[qKey];
                     let statusHtml = quizState.submitted ? (userAns == q.ans ? '<span class="quiz-res correct">âœ…</span>' : '<span class="quiz-res wrong">âŒ</span>') : '';
                     
                     // é€‰é¡¹æ¨ªæ’å®¹å™¨
                     let optsHtml = `<div class="quiz-opts-row">`;
                     optsHtml += q.opts.map((opt, oIdx) => {
                         let checked = userAns == oIdx ? 'checked' : '';
                         // ABCD å­—æ¯
                         let letter = String.fromCharCode(65 + oIdx); 
                         return `<label class="quiz-opt"><input type="radio" name="${qKey}" value="${oIdx}" ${checked} onclick="selectQuizAns('${qKey}', ${oIdx})"> ${letter}. ${opt}</label>`;
                     }).join('');
                     optsHtml += `</div>`;
                     
                     quizHtml += `<div class="quiz-item"><div class="quiz-q">${i+1}. ${q.q} ${statusHtml}</div>${optsHtml}</div>`;
                 });
                 
                 let actionBtns = !quizState.submitted ? `<button class="game-btn active" onclick="submitQuiz(${idx})">æäº¤ç­”æ¡ˆ</button>` : 
                    `<span style="font-weight:bold;margin-right:10px;">å¾—åˆ†: ${calculateQuizScore(idx)}%</span>` + (calculateQuizScore(idx)<100 ? `<button class="regret-btn" style="display:inline-block" onclick="useQuizRegret()">ğŸ’Š åæ‚”è¯(20åˆ†)</button>` : '');
                 quizHtml += `<div style="margin-top:15px;padding-top:10px;">${actionBtns}</div></div>`;
                 
                 contentHtml += quizHtml;
             }
        }
        
        container.innerHTML = contentHtml;
        let pgHtml = ''; pages.forEach((_, i) => pgHtml += `<button onclick="renderStudyPage(${i})" style="margin:5px;padding:5px 12px;border:1px solid #ccc;background:${i===idx?'#5a4fcf':'white'};color:${i===idx?'white':'black'};border-radius:6px;cursor:pointer;">${i+1}</button>`);
        document.getElementById('studyPagination').innerHTML = pgHtml;
    }

    function selectQuizAns(key, val) { if(!quizState.submitted) quizState.answers[key] = val; }
    function submitQuiz(idx) { quizState.submitted = true; renderStudyPage(idx); }
    function calculateQuizScore(idx) {
        let qs = (currentData.reading||[]).concat(currentData.listening||[])[idx].questions;
        if(!qs) return 0;
        let c=0; qs.forEach((q, i) => { if(quizState.answers[`q${idx}_${i}`] == q.ans) c++; });
        return Math.round((c/qs.length)*100);
    }
    function useQuizRegret() { if(confirm("æ¶ˆè€—20ç§¯åˆ†ä¿®æ”¹ï¼Ÿ")) { deductScore(20); quizState.submitted=false; renderStudyPage(Array.from(document.querySelectorAll('#studyPagination button')).findIndex(b=>b.style.backgroundColor!=='white')); } }
    
    function toggleTrans() { if(prompt("å¯†ç :")==="666") document.querySelectorAll('.translation-box').forEach(e => e.style.display=e.style.display==='none'?'block':'none'); else alert("é”™"); }
    function speak(txt) { window.speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(txt); u.lang='en-GB'; window.speechSynthesis.speak(u); }

    // === Game Logic ===
    function setGameMode(m, b) { 
        gameState.mode=m; 
        if(m==='match'){gameState.match.deck=[]; gameState.match.init=false; gameState.match.correct=0; gameState.match.wrong=0;}
        if(m==='spell'){gameState.spell.correct=0; gameState.spell.wrong=0; gameState.idx=0;}
        if(m==='sentence'){gameState.sentence.idx=0; gameState.sentence.correctCount=0; gameState.sentence.userWords=[]; gameState.sentence.regretUsed=0;}
        document.querySelectorAll('.game-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderGame(); 
    }
    
    function renderGame() {
        const b = document.getElementById('gameBoard');
        if(!currentData.vocab) { b.innerHTML="No Vocab"; return; }
        let s = currentData.sentences||[];
        
        if(gameState.mode === 'flashcard') {
            let vLen = currentData.vocab.length;
            let w = currentData.vocab[gameState.idx];
            b.innerHTML = `<div class="flashcard-scene" onclick="this.querySelector('.flashcard').classList.toggle('flipped');speak('${w.en}')"><div class="flashcard"><div class="fc-face fc-front">${w.en}<div class="pron">${w.pron||''}</div></div><div class="fc-face fc-back">${w.cn}</div></div></div>
            <div style="display:flex;gap:10px;"><button class="game-btn" onclick="gameState.idx=(gameState.idx-1+${vLen})%${vLen};renderGame()">â¬…ï¸ Prev</button><button class="game-btn" onclick="gameState.idx=(gameState.idx+1)%${vLen};renderGame()">Next â¡ï¸</button></div>`;
        }
        else if(gameState.mode === 'match') {
            if(!gameState.match.init || gameState.lastDay!==currentDay) {
                let deck = [];
                currentData.vocab.slice(0,8).forEach((item, i) => {
                    deck.push({ idx: i, type: 'en', txt: item.en });
                    deck.push({ idx: i, type: 'cn', txt: item.cn });
                });
                deck.sort(() => Math.random() - 0.5);
                gameState.match.deck = deck;
                gameState.match.selected = [];
                gameState.match.resolved = [];
                gameState.match.init = true;
                gameState.lastDay = currentDay;
            }
            let html = `<div class="game-stats"><span class="stat-pill ok">âœ… ${gameState.match.correct}</span><span class="stat-pill err">âŒ ${gameState.match.wrong}</span></div><div class="match-grid">`;
            gameState.match.deck.forEach((card, i) => {
                let isResolved = gameState.match.resolved.includes(card.idx);
                let isSel = gameState.match.selected.includes(i);
                let style = isResolved ? 'visibility:hidden' : '';
                let cls = isSel ? 'match-card selected' : 'match-card';
                html += `<div class="${cls}" style="${style}" onclick="handleMatch(${i})">${card.txt}</div>`;
            });
            b.innerHTML = html + '</div><button onclick="setGameMode(\'match\', document.querySelector(\'.game-btn.active\'))" style="margin-top:20px;">Restart</button>';
        }
        else if(gameState.mode === 'spell') {
            let w = currentData.vocab[gameState.idx];
            b.innerHTML = `<div class="game-stats"><span class="stat-pill ok">âœ… ${gameState.spell.correct}</span><span class="stat-pill err">âŒ ${gameState.spell.wrong}</span></div><h2>${w.cn}</h2><input id="spi" class="spell-input" autocomplete="off"><br><button class="game-btn" style="margin-top:20px" onclick="checkSpell('${w.en}')">Check</button>`;
        }
        else if(gameState.mode === 'sentence') {
            if(s.length===0){b.innerHTML="No Sentences";return;}
            if(gameState.sentence.idx>=s.length){ b.innerHTML=`<h2>ğŸ‰ å®Œæˆ!</h2><p>æ­£ç¡®ç‡: ${Math.round((gameState.sentence.correctCount/s.length)*100)}%</p><button class="game-btn" onclick="setGameMode('sentence',document.querySelectorAll('.game-btn')[3])">Replay</button>`; return; }
            let item = s[gameState.sentence.idx];
            if(!item.shuffled) item.shuffled = [...item.words].sort(()=>Math.random()-0.5);
            let ansH = gameState.sentence.userWords.map((w,i)=>`<div class="word-chip" onclick="removeWord(${i})">${w}</div>`).join('');
            let bnkH = item.shuffled.map(w=>`<div class="word-chip" onclick="addWord('${w}')">${w}</div>`).join('');
            let regH = gameState.sentence.regretUsed===0 ? `<button class="regret-btn" onclick="useRegret(20)">ğŸ’Š (20)</button>` : (gameState.sentence.regretUsed===1 ? `<button class="regret-btn" onclick="useRegret(50)">ğŸ’Š (50)</button>` : '');
            b.innerHTML=`<h3 style="color:#5a4fcf">Q${gameState.sentence.idx+1}/${s.length}</h3><h2 style="margin:10px 0;">${item.cn}</h2><div class="sent-box">${ansH}</div><div class="word-bank">${bnkH}</div><div style="margin-top:20px;display:flex;justify-content:center;align-items:center;"><button class="game-btn" style="background:#00b894;color:white;" onclick="checkSentence()">Submit</button>${regH}</div><div id="sent-msg" style="margin-top:10px;font-weight:bold;height:20px;"></div>`;
        }
    }

    function handleMatch(domIdx) {
        let card = gameState.match.deck[domIdx];
        let sel = gameState.match.selected;
        if(gameState.match.resolved.includes(card.idx) || sel.includes(domIdx)) return;
        
        if(card.type==='en') speak(card.txt);
        sel.push(domIdx);
        renderGame();

        if(sel.length === 2) {
            let c1 = gameState.match.deck[sel[0]];
            let c2 = gameState.match.deck[sel[1]];
            if(c1.idx === c2.idx && c1.type !== c2.type) {
                setTimeout(() => { gameState.match.resolved.push(c1.idx); gameState.match.selected = []; gameState.match.correct++; renderGame(); }, 300);
            } else {
                setTimeout(() => { gameState.match.selected = []; gameState.match.wrong++; renderGame(); }, 600);
            }
        }
    }

    function checkSpell(a){ let v=document.getElementById('spi').value.toLowerCase(); if(v===a.toLowerCase()){speak(a);alert('Correct!');gameState.spell.correct++;gameState.idx=(gameState.idx+1)%currentData.vocab.length;}else{gameState.spell.wrong++;alert('Try again');} renderGame(); }
    function addWord(w){ speak(w); gameState.sentence.userWords.push(w); renderGame(); }
    function removeWord(i){ gameState.sentence.userWords.splice(i,1); renderGame(); }
    function useRegret(c){ if(confirm(`æ‰£é™¤${c}åˆ†?`)){deductScore(c);gameState.sentence.regretUsed++;document.getElementById('sent-msg').innerText="";document.querySelector('.regret-btn').style.display='none';renderGame();} }
    function checkSentence(){
        let s=currentData.sentences[gameState.sentence.idx]; let u=gameState.sentence.userWords.join(' ');
        if(u===s.en){ speak(s.en); document.getElementById('sent-msg').style.color='green'; document.getElementById('sent-msg').innerText="âœ… Correct!"; gameState.sentence.correctCount++; setTimeout(()=>{gameState.sentence.idx++;gameState.sentence.userWords=[];gameState.sentence.regretUsed=0;renderGame();},1000); }
        else { document.getElementById('sent-msg').style.color='red'; document.getElementById('sent-msg').innerText="âŒ Wrong!"; let b=document.querySelector('.regret-btn'); if(b)b.style.display='block'; }
    }
</script>
</body>
</html>