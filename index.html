<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Eric's Station Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <style>
        :root { 
            --primary: #5a4fcf; --bg: #f0f2f5; --white: #ffffff; --text: #333;
            --sidebar-width: 220px; --success: #00b894; --warn: #fdcb6e; --danger: #ff7675;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; display: flex; height: 100vh; overflow: hidden; }
        
        /* === ä¾§è¾¹æ  === */
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, var(--primary), #8e7bf0); color: white; display: flex; flex-direction: column; padding: 20px; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        .app-logo { font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .avatar { width: 36px; height: 36px; background: white; color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .nav-btn { background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.9); padding: 15px; margin-bottom: 10px; border-radius: 12px; text-align: left; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .nav-btn.active { background: white; color: var(--primary); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .day-picker label { font-size:12px; opacity:0.8; }
        .day-picker select { width: 100%; padding: 8px; border-radius: 5px; border: none; font-weight: bold; margin-bottom: 20px; cursor: pointer; color: var(--primary); }

        /* === ä¸»å†…å®¹åŒº === */
        .main-content { flex: 1; overflow-y: auto; padding: 20px; position: relative; -webkit-overflow-scrolling: touch; }
        .section { display: none; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* === Dashboard V2.1 === */
        .dash-header-card { background: linear-gradient(135deg, #5a4fcf, #ac92ec); color: white; border-radius: 15px; padding: 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 10px 20px rgba(90, 79, 207, 0.3); margin-bottom: 20px; }
        .stats-box { display: flex; gap: 30px; text-align: center; }
        .stat-item .num { font-size: 32px; font-weight: 800; line-height: 1; }
        .stat-item .label { font-size: 12px; opacity: 0.9; margin-top: 5px; }

        .control-bar { display: flex; justify-content: space-between; align-items: center; background: white; padding: 15px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-section { background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.03); }
        .progress-track { width: 100%; height: 12px; background: #eee; border-radius: 6px; overflow: hidden; margin-top:10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #00b894, #00cec9); width: 0%; transition: width 0.5s ease; }

        .table-container { background: white; border-radius: 12px; padding: 10px; box-shadow: 0 2px 15px rgba(0,0,0,0.05); overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 900px; }
        th { background: #f8f9fa; color: #636e72; font-size: 13px; padding: 15px 10px; text-align: center; border-bottom: 2px solid #eee; }
        td { padding: 12px 8px; border-bottom: 1px solid #f1f1f1; text-align: center; vertical-align: middle; font-size: 14px; color: #2d3436; }
        
        .tag { display: inline-block; font-size: 11px; padding: 2px 6px; border-radius: 4px; color: white; margin-bottom: 4px; }
        .tag.pink { background: #e84393; } .tag.blue { background: #0984e3; } .tag.green { background: #00b894; } .tag.orange { background: #e17055; }
        .review-tag { background: #00b894; color: white; font-size: 10px; padding: 2px 5px; border-radius: 4px; display: flex; align-items: center; gap: 5px; margin-bottom:2px; white-space: nowrap; }
        .score-input { width: 40px; padding: 5px; text-align: center; border: 1px solid #dfe6e9; border-radius: 4px; }
        .check-btn { width: 20px; height: 20px; cursor: pointer; accent-color: #5a4fcf; }

        /* === Study & Game === */
        .study-container, .game-area { background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; min-height: 400px; display: flex; flex-direction: column; }
        .study-header { display: flex; justify-content: space-between; border-bottom: 2px solid #f1f2f6; padding-bottom: 15px; margin-bottom: 20px; }
        .listen-item { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .vocab-hl { color: #d35400; font-weight: bold; background: #fff5e6; padding: 0 4px; border-radius: 4px; }
        
        .game-nav { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .game-btn { background: white; border: 1px solid #eee; padding: 8px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .game-btn.active { background: var(--primary); color: white; }
        
        /* Flashcard */
        .flashcard-scene { perspective: 1000px; width: 300px; height: 200px; cursor: pointer; margin: 0 auto 20px; }
        .flashcard { width: 100%; height: 100%; position: relative; transition: transform 0.6s; transform-style: preserve-3d; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .flashcard.flipped { transform: rotateY(180deg); }
        .fc-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 20px; background: white; border: 1px solid #eee; }
        .fc-front { color: var(--primary); font-size: 32px; font-weight: 800; }
        .fc-back { background: var(--primary); color: white; transform: rotateY(180deg); font-size: 28px; }
        .pron { font-size: 14px; color: #888; margin-top: 5px; font-weight: normal; font-family: "Arial", sans-serif; }

        /* Match Game */
        .match-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .match-card { background: #f8f9fa; height: 60px; display: flex; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; font-weight: bold; border: 2px solid transparent; font-size: 14px; user-select: none; }
        .match-card.selected { border-color: var(--primary); background: #eeeaf9; color: var(--primary); transform: scale(1.05); }
        .match-card.shake { animation: shake 0.4s; border-color: red; background: #ffe0e0; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* Spell Game */
        .spell-input { font-size: 24px; padding: 10px; text-align: center; border: 2px solid #ddd; border-radius: 10px; width: 60%; font-family: monospace; letter-spacing: 2px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="app-logo"><div class="avatar">EC</div> Eric's Station</div>
    <div class="day-picker">
        <label>å¿«é€Ÿè·³è½¬:</label>
        <select id="globalDaySelect" onchange="changeGlobalDay()"></select>
    </div>
    <button class="nav-btn active" onclick="showSection('dashboard', this)">ğŸ›¡ï¸ å¤‡è€ƒæŒ‡æŒ¥å®˜</button>
    <button class="nav-btn" onclick="showSection('study', this)">ğŸ“– æ ¸å¿ƒè®­ç»ƒ</button>
    <button class="nav-btn" onclick="showSection('game', this)">ğŸ® ç«æŠ€åœº</button>
</div>

<div class="main-content">

    <div id="dashboard" class="section active">
        <div class="dash-header-card">
            <div class="header-title"><h2>ğŸ›¡ï¸ KET å¤‡è€ƒæŒ‡æŒ¥å®˜ V2.1</h2><p>Target: Grade A | æ¯æ—¥é—­ç¯ Â· å¥‘çº¦ç²¾ç¥</p></div>
            <div class="stats-box">
                <div class="stat-item"><div class="num" id="displayTotalScore">0</div><div class="label">æ€»ç§¯åˆ† (EXP)</div></div>
                <div class="stat-item"><div class="num" id="displayStreak">0</div><div class="label">è¿ç»­æ‰“å¡ (DAYS)</div></div>
            </div>
        </div>
        <div class="control-bar">
            <div>ğŸ“… å¼€å§‹æ—¥æœŸ: <input type="date" id="startDateInput" onchange="updateStartDate()"></div>
            <button onclick="if(confirm('é‡ç½®æ‰€æœ‰æ•°æ®ï¼Ÿ')) {localStorage.clear(); location.reload();}" style="background:#ff7675; color:white; border:none; padding:5px 10px; border-radius:5px;">âš ï¸ é‡ç½®</button>
        </div>
        <div class="progress-section">
            <div style="display:flex; justify-content:space-between; font-size:14px; font-weight:bold; color:#555;">
                <span>ğŸ å¥–åŠ±è¿›åº¦æ¡</span><span id="nextTargetText">ä¸‹ä¸€ç›®æ ‡: 300åˆ†</span>
            </div>
            <div class="progress-track"><div class="progress-fill" id="progressBar" style="width: 0%"></div></div>
        </div>
        <div class="table-container">
            <table>
                <thead>
                    <tr><th style="width:60px;">Date<br>Day</th><th>ğŸ“ å•è¯æ‰“å¡</th><th>ğŸ§ å¬è¯»ç‡</th><th>âœï¸ å†™ä½œ</th><th>ğŸ—£ï¸ å£è¯­</th><th>ğŸ“± APPs</th><th>ğŸ‘¨â€ğŸ« å¤–æ•™</th><th>ğŸ”„ é—å¿˜å¤ä¹ </th><th>å¾—åˆ†</th></tr>
                </thead>
                <tbody id="dashBody"></tbody>
            </table>
        </div>
    </div>

    <div id="study" class="section">
        <div class="study-container">
            <div class="study-header"><h2 style="margin:0; color:#5a4fcf;" id="studyTitle">Day X</h2><button onclick="toggleTrans()" style="background:#fdcb6e; border:none; padding:5px 15px; border-radius:15px; color:white;">ğŸ‘ï¸ ç¿»è¯‘</button></div>
            <div id="studyContent"></div>
            <div style="margin-top:20px; text-align:center;" id="studyPagination"></div>
        </div>
    </div>

    <div id="game" class="section">
        <div class="game-nav">
            <button class="game-btn active" onclick="setGameMode('flashcard', this)">âš¡ é—ªå¡</button>
            <button class="game-btn" onclick="setGameMode('match', this)">ğŸ§© æ¶ˆæ¶ˆä¹</button>
            <button class="game-btn" onclick="setGameMode('spell', this)">âœï¸ æ‹¼å†™</button>
        </div>
        <div class="game-area" id="gameBoard" style="align-items:center; justify-content:center;"></div>
    </div>

</div>

<script>
    // ================== æ ¸å¿ƒæ•°æ® (Day 1 & Day 2 å®Œæ•´å†…å®¹) ==================
    const KET_DATA = {
        1: {
            theme: "People & Family",
            vocab: [
                {en: "aunt", cn: "é˜¿å§¨/å§‘å§‘", pron: "/É‘Ënt/"}, {en: "cousin", cn: "å ‚(è¡¨)å…„å¼Ÿ", pron: "/ËˆkÊŒzn/"}, 
                {en: "grandchild", cn: "å­™å­/å­™å¥³", pron: "/ËˆÉ¡rÃ¦n.tÊƒaÉªld/"}, {en: "guest", cn: "å®¢äºº", pron: "/É¡est/"}, 
                {en: "husband", cn: "ä¸ˆå¤«", pron: "/ËˆhÊŒz.bÉ™nd/"}, {en: "neighbor", cn: "é‚»å±…", pron: "/ËˆneÉª.bÉ™r/"}, 
                {en: "surname", cn: "å§“æ°", pron: "/ËˆsÉœË.neÉªm/"}, {en: "teenager", cn: "é’å°‘å¹´", pron: "/ËˆtiËnËŒeÉª.dÊ’É™r/"}, 
                {en: "wife", cn: "å¦»å­", pron: "/waÉªf/"}, {en: "colleague", cn: "åŒäº‹", pron: "/ËˆkÉ’l.iËÉ¡/"}, 
                {en: "adult", cn: "æˆå¹´äºº", pron: "/ËˆÃ¦d.ÊŒlt/"}, {en: "member", cn: "æˆå‘˜", pron: "/Ëˆmem.bÉ™r/"}
            ],
            reading: [
                { title: "Reading 1: The Family Party", content: `Hello, my name is Sam. Today is Saturday. We have a big party at my house. There are many <span class="vocab-hl">guests</span>. Look at the woman in the red dress. She is my <span class="vocab-hl">aunt</span>, Lisa. She is my dad's sister. The boy next to her is Mike. He is my <span class="vocab-hl">cousin</span>. Mike is 15 years old. He is a <span class="vocab-hl">teenager</span>.`, translation: "ä½ å¥½ï¼Œæˆ‘æ˜¯è¨å§†ã€‚ä»Šå¤©æ˜¯å‘¨å…­ï¼Œæˆ‘å®¶æœ‰ä¸ªå¤§æ´¾å¯¹ã€‚æœ‰å¾ˆå¤šå®¢äººã€‚çœ‹é‚£ä¸ªç©¿çº¢è£™çš„å¥³å£«ï¼Œæ˜¯æˆ‘é˜¿å§¨Lisaï¼Œçˆ¸çˆ¸çš„å§å§ã€‚æ—è¾¹æ˜¯Mikeï¼Œæˆ‘å ‚å…„ï¼Œ15å²ï¼Œæ˜¯ä¸ªé’å°‘å¹´ã€‚" },
                { title: "Reading 2: My Neighbors", content: `I live in a nice house. I have a very good <span class="vocab-hl">neighbor</span>. His name is Mr. White. So his <span class="vocab-hl">surname</span> is White. Mr. White lives with Mrs. White. She is his <span class="vocab-hl">wife</span>, and he is her <span class="vocab-hl">husband</span>. They are both <span class="vocab-hl">adults</span>. They like gardening.`, translation: "æˆ‘ä½åœ¨ä¸€ä¸ªæ¼‚äº®çš„æˆ¿å­é‡Œã€‚æˆ‘æœ‰ä¸€ä¸ªå¥½é‚»å±…å«æ€€ç‰¹å…ˆç”Ÿã€‚ä»–å’Œæ€€ç‰¹å¤ªå¤ªä½ä¸€èµ·ï¼Œå¥¹æ˜¯ä»–çš„å¦»å­ã€‚ä»–ä»¬éƒ½æ˜¯æˆå¹´äººï¼Œå–œæ¬¢å›­è‰ºã€‚" }
            ],
            listening: [
                { title: "Listening Part 1", content: [
                    {text: "1. He works with my dad. He is my dad's ___.", audioText: "This is Mr. Li. He works with my dad. He is my dad's colleague.", translation: "è¿™æ˜¯æå…ˆç”Ÿï¼Œçˆ¸çˆ¸çš„åŒäº‹ã€‚"},
                    {text: "2. My name is Tom Brown. My ___ is Brown.", audioText: "My name is Tom Brown. My surname is Brown.", translation: "æˆ‘å«Tom Brownï¼Œå§“Brownã€‚"},
                    {text: "3. My grandma loves me. I am her happy ___.", audioText: "My grandma loves me very much. I am her happy grandchild.", translation: "å¥¶å¥¶å¾ˆçˆ±æˆ‘ï¼Œæˆ‘æ˜¯å¥¹å¿«ä¹çš„å­™å­ã€‚"}
                ]}
            ]
        },
        2: {
            theme: "School & Education",
            vocab: [
                {en: "subject", cn: "ç§‘ç›®", pron: "/ËˆsÊŒb.dÊ’ekt/"}, {en: "board", cn: "é»‘æ¿", pron: "/bÉ”Ëd/"}, 
                {en: "break", cn: "ä¼‘æ¯/è¯¾é—´", pron: "/breÉªk/"}, {en: "chemistry", cn: "åŒ–å­¦", pron: "/Ëˆkem.Éª.stri/"}, 
                {en: "college", cn: "å­¦é™¢", pron: "/ËˆkÉ’l.ÉªdÊ’/"}, {en: "course", cn: "è¯¾ç¨‹", pron: "/kÉ”Ës/"}, 
                {en: "exam", cn: "è€ƒè¯•", pron: "/ÉªÉ¡ËˆzÃ¦m/"}, {en: "geography", cn: "åœ°ç†", pron: "/dÊ’iËˆÉ’É¡.rÉ™.fi/"}, 
                {en: "history", cn: "å†å²", pron: "/ËˆhÉªs.tÉ™r.i/"}, {en: "project", cn: "é¡¹ç›®", pron: "/ËˆprÉ’dÊ’.ekt/"}, 
                {en: "ruler", cn: "å°ºå­", pron: "/ËˆruË.lÉ™r/"}, {en: "uniform", cn: "æ ¡æœ", pron: "/ËˆjuË.nÉª.fÉ”Ëm/"}
            ],
            reading: [
                { title: "Reading 1: My School Day", content: `I love my school. We study many <span class="vocab-hl">subjects</span>. My favorite subject is <span class="vocab-hl">history</span>. I don't like <span class="vocab-hl">chemistry</span> because it is difficult. We wear a blue <span class="vocab-hl">uniform</span> at school. In the classroom, the teacher writes on the <span class="vocab-hl">board</span>. We have a short <span class="vocab-hl">break</span> in the morning.`, translation: "æˆ‘çˆ±æˆ‘çš„å­¦æ ¡ã€‚æˆ‘ä»¬å­¦å¾ˆå¤šç§‘ç›®ã€‚æˆ‘æœ€çˆ±å†å²ï¼Œä¸å–œæ¬¢åŒ–å­¦å› ä¸ºå¤ªéš¾ã€‚æˆ‘ä»¬ç©¿è“è‰²æ ¡æœã€‚è€å¸ˆåœ¨é»‘æ¿ä¸Šå†™å­—ã€‚æ—©ä¸Šæˆ‘ä»¬æœ‰çŸ­æš‚ä¼‘æ¯ã€‚" },
                { title: "Reading 2: The Big Exam", content: `Today we have a big <span class="vocab-hl">exam</span>. I need my pen and <span class="vocab-hl">ruler</span>. We are doing a <span class="vocab-hl">project</span> about world maps in <span class="vocab-hl">geography</span> class. After high school, I want to go to a good <span class="vocab-hl">college</span>.`, translation: "ä»Šå¤©æœ‰å¤§è€ƒã€‚æˆ‘éœ€è¦ç¬”å’Œå°ºå­ã€‚åœ°ç†è¯¾æˆ‘ä»¬åœ¨åšä¸–ç•Œåœ°å›¾é¡¹ç›®ã€‚é«˜ä¸­åæˆ‘æƒ³å»å¥½å¤§å­¦ã€‚" }
            ],
            listening: [
                { title: "Listening Part 1", content: [
                    {text: "1. Don't forget your ___. You need to draw lines.", audioText: "Don't forget your ruler. You need to draw lines in the math exam.", translation: "åˆ«å¿˜äº†å°ºå­ï¼Œä½ éœ€è¦ç”»çº¿ã€‚"},
                    {text: "2. I wear a white shirt. This is my school ___.", audioText: "I wear a white shirt and grey trousers. This is my school uniform.", translation: "æˆ‘ç©¿ç™½è¡¬è¡«ï¼Œè¿™æ˜¯æˆ‘çš„æ ¡æœã€‚"}
                ]}
            ]
        }
    };

    // ================= é€»è¾‘ç¨‹åº =================
    const CURVE = [1, 2, 4, 7, 15];
    const LEVEL_GAP = 300;
    let currentDay = 1;
    let currentData = KET_DATA[1];
    let gameState = { mode: 'flashcard', idx: 0, match: { selected: [], deck: [] } };

    window.onload = function() {
        // Init Date
        let sd = localStorage.getItem('ket_start_date');
        if(!sd) { sd = new Date().toISOString().split('T')[0]; localStorage.setItem('ket_start_date', sd); }
        document.getElementById('startDateInput').value = sd;

        // Init Select
        const sel = document.getElementById('globalDaySelect');
        for(let i=1; i<=14; i++) { let opt = document.createElement('option'); opt.value = i; opt.innerText = `Day ${i}`; sel.appendChild(opt); }

        loadDayData(1);
        renderDashboard();
    };

    function updateStartDate() { localStorage.setItem('ket_start_date', document.getElementById('startDateInput').value); renderDashboard(); }
    function changeGlobalDay() { loadDayData(parseInt(document.getElementById('globalDaySelect').value)); }

    function loadDayData(day) {
        currentDay = day;
        currentData = KET_DATA[day] || { theme: "Review", vocab: [], reading: [], listening: [] };
        document.getElementById('studyTitle').innerText = `Day ${day}: ${currentData.theme || 'Review'}`;
        if(document.getElementById('study').classList.contains('active')) renderStudyPage(0);
        if(document.getElementById('game').classList.contains('active')) renderGame();
    }

    function renderDashboard() {
        const tbody = document.getElementById('dashBody'); tbody.innerHTML = '';
        let totalScore = 0; let streak = 0;
        const startDate = new Date(localStorage.getItem('ket_start_date'));

        for (let i = 1; i <= 14; i++) {
            let rowDate = new Date(startDate); rowDate.setDate(startDate.getDate() + (i - 1));
            let dateStr = `${(rowDate.getMonth()+1).toString().padStart(2,'0')}-${rowDate.getDate().toString().padStart(2,'0')}`;
            let data = JSON.parse(localStorage.getItem(`day_${i}_data`) || '{}');
            
            let dayScore = 0;
            if(data.vocab) dayScore += 10; if(data.apps) dayScore += 5; if(data.teacher) dayScore += 10;
            if(data.reviews) Object.values(data.reviews).forEach(v => { if(v) dayScore += 15; });
            if(dayScore > 0) streak++; totalScore += dayScore;

            let theme = KET_DATA[i] ? KET_DATA[i].theme.split(' ')[0] : 'Review';
            let tagColor = ['pink', 'blue', 'green', 'orange'][i % 4];

            let reviewHtml = '';
            for(let j=1; j<i; j++) {
                if(CURVE.includes(i - j)) {
                    reviewHtml += `<label class="review-tag"><span style="font-weight:bold">å¤ä¹  D${j}</span><input type="checkbox" ${data.reviews && data.reviews[j]?'checked':''} onchange="updateReview(${i}, ${j}, this.checked)"></label>`;
                }
            }

            tbody.innerHTML += `<tr>
                <td class="day-cell"><span class="day-date">${dateStr}</span><span class="day-num">D${i}</span></td>
                <td style="text-align:left"><span class="tag ${tagColor}">${theme}</span><br><label style="cursor:pointer;font-size:12px;"><input type="checkbox" class="check-btn" ${data.vocab?'checked':''} onchange="updateData(${i}, 'vocab', this.checked)"> æ‰“å¡</label></td>
                <td><input class="score-input" placeholder="%" value="${data.listen||''}" onchange="updateData(${i}, 'listen', this.value)"></td>
                <td><input class="score-input" placeholder="-" value="${data.write||''}" onchange="updateData(${i}, 'write', this.value)"></td>
                <td><input class="score-input" placeholder="-" value="${data.speak||''}" onchange="updateData(${i}, 'speak', this.value)"></td>
                <td><input type="checkbox" class="check-btn" ${data.apps?'checked':''} onchange="updateData(${i}, 'apps', this.checked)"></td>
                <td><input type="checkbox" class="check-btn" ${data.teacher?'checked':''} onchange="updateData(${i}, 'teacher', this.checked)"></td>
                <td><div style="display:flex;flex-direction:column;gap:2px;">${reviewHtml}</div></td>
                <td><span style="font-weight:bold;color:#5a4fcf;">${dayScore}</span></td>
            </tr>`;
        }
        document.getElementById('displayTotalScore').innerText = totalScore;
        document.getElementById('displayStreak').innerText = streak;
        let nextTarget = (Math.floor(totalScore / LEVEL_GAP) + 1) * LEVEL_GAP;
        document.getElementById('progressBar').style.width = `${((totalScore % LEVEL_GAP) / LEVEL_GAP) * 100}%`;
        document.getElementById('nextTargetText').innerText = `ä¸‹ä¸€ç›®æ ‡: ${nextTarget}åˆ†`;
    }

    function updateData(day, field, value) {
        let data = JSON.parse(localStorage.getItem(`day_${day}_data`) || '{}');
        data[field] = value; localStorage.setItem(`day_${day}_data`, JSON.stringify(data)); renderDashboard();
    }
    function updateReview(day, target, checked) {
        let data = JSON.parse(localStorage.getItem(`day_${day}_data`) || '{}');
        if(!data.reviews) data.reviews = {}; data.reviews[target] = checked;
        localStorage.setItem(`day_${day}_data`, JSON.stringify(data)); renderDashboard();
    }

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(el => el.classList.remove('active')); document.getElementById(id).classList.add('active');
        if(btn) { document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active')); btn.classList.add('active'); }
        if(id==='study') renderStudyPage(0); if(id==='game') renderGame();
    }

    function renderStudyPage(idx) {
        const c = document.getElementById('studyContent');
        if(!currentData.reading) { c.innerHTML="æš‚æ— å†…å®¹"; return; }
        let pages = (currentData.reading||[]).concat(currentData.listening||[]);
        if(pages.length===0) return;
        let p = pages[idx];
        
        let contentHtml = '';
        if(p.content && Array.isArray(p.content)) { // Listening list
             contentHtml = p.content.map(i => `<div class="listen-item"><span>${i.text}</span><button onclick="speak('${i.audioText}')">ğŸ”Š</button><div class="translation-box" style="display:none;color:#666;margin-top:5px;">${i.translation}</div></div>`).join('');
        } else { // Reading text
             contentHtml = `<div style="font-size:18px;line-height:1.8;">${p.content}</div><div class="translation-box" style="display:none;background:#eee;padding:10px;margin-top:10px;">${p.translation}</div>`;
             if(p.content.length > 50) contentHtml += `<button onclick="speak(document.querySelector('#studyContent div').innerText)" style="margin-top:10px;background:#00b894;color:white;border:none;padding:5px 15px;border-radius:15px;">â–¶ æœ—è¯»</button>`;
        }
        c.innerHTML = `<h3>${p.title||'Practice'}</h3>${contentHtml}`;
        
        let pgHtml = ''; pages.forEach((_, i) => pgHtml += `<button onclick="renderStudyPage(${i})" style="margin:5px;padding:5px 10px;border:1px solid #ccc;background:${i===idx?'#5a4fcf':'white'};color:${i===idx?'white':'black'}">${i+1}</button>`);
        document.getElementById('studyPagination').innerHTML = pgHtml;
    }
    function toggleTrans() { document.querySelectorAll('.translation-box').forEach(e => e.style.display = e.style.display==='none'?'block':'none'); }
    function speak(txt) { window.speechSynthesis.cancel(); let u=new SpeechSynthesisUtterance(txt); u.lang='en-GB'; window.speechSynthesis.speak(u); }

    function setGameMode(m, b) { gameState.mode = m; gameState.idx = 0; document.querySelectorAll('.game-btn').forEach(e=>e.classList.remove('active')); b.classList.add('active'); renderGame(); }
    function renderGame() {
        const b = document.getElementById('gameBoard');
        if(!currentData.vocab) { b.innerHTML="No Vocab"; return; }
        let v = currentData.vocab;
        
        if(gameState.mode === 'flashcard') {
            let w = v[gameState.idx];
            b.innerHTML = `<div class="flashcard-scene" onclick="this.querySelector('.flashcard').classList.toggle('flipped');speak('${w.en}')">
                <div class="flashcard"><div class="fc-face fc-front">${w.en}<div class="pron">${w.pron||''}</div></div><div class="fc-face fc-back">${w.cn}</div></div>
            </div><button class="game-btn" onclick="gameState.idx=(gameState.idx+1)%${v.length};renderGame()">Next</button>`;
        } 
        else if(gameState.mode === 'match') {
            if(!gameState.match.init || gameState.lastDay !== currentDay) {
                let deck = []; v.slice(0,8).forEach((x,i)=>{deck.push({id:i,txt:x.en,type:'en'},{id:i,txt:x.cn,type:'cn'})});
                deck.sort(()=>Math.random()-0.5); gameState.match.deck=deck; gameState.match.selected=[]; gameState.match.init=true; gameState.lastDay=currentDay;
            }
            let html = '<div class="match-grid">';
            gameState.match.deck.forEach((c,i) => html+=`<div id="mc_${i}" class="match-card" onclick="handleMatch(${i},${c.id},'${c.txt}','${c.type}')">${c.txt}</div>`);
            b.innerHTML = html + '</div><button onclick="gameState.match.init=false;renderGame()" style="margin-top:20px;">Restart</button>';
        }
        else if(gameState.mode === 'spell') {
            let w = v[gameState.idx];
            b.innerHTML = `<h2>${w.cn}</h2><input id="spi" class="spell-input" autocomplete="off"><br><button class="game-btn" style="margin-top:20px" onclick="checkSpell('${w.en}')">Check</button>`;
        }
    }
    function handleMatch(idx, id, txt, type) {
        let el = document.getElementById(`mc_${idx}`);
        if(el.style.opacity==='0' || el.classList.contains('selected')) return;
        if(type==='en') speak(txt); el.classList.add('selected'); gameState.match.selected.push({idx,id,el});
        if(gameState.match.selected.length === 2) {
            let [c1,c2] = gameState.match.selected;
            if(c1.id===c2.id && c1.idx!==c2.idx) { setTimeout(()=>{c1.el.style.opacity=0;c2.el.style.opacity=0;},300); }
            else { setTimeout(()=>{c1.el.classList.remove('selected');c2.el.classList.remove('selected');},500); }
            gameState.match.selected=[];
        }
    }
    function checkSpell(ans) {
        let val = document.getElementById('spi').value.trim().toLowerCase();
        if(val===ans.toLowerCase()) { speak(ans); alert('Correct!'); gameState.idx=(gameState.idx+1)%currentData.vocab.length; renderGame(); }
        else { alert('Try again'); }
    }
</script>
</body>
</html>